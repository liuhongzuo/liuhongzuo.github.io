import os
import re

# 匹配 #include "..." 格式的正则，过滤掉标准库 <...>
INCLUDE_PATTERN = re.compile(r'#\s*include\s*"(.*?)"')

def get_dependencies(file_path, root_dir):
    """解析单个文件的头文件依赖"""
    dependencies = []
    if not os.path.exists(file_path):
        return dependencies

    with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
        lines = f.readlines()
        
    for line in lines:
        match = INCLUDE_PATTERN.search(line)
        if match:
            include_path = match.group(1)
            
            # 逻辑 1：尝试相对于当前文件路径解析 (../common/...)
            current_file_dir = os.path.dirname(file_path)
            path_relative_to_file = os.path.normpath(os.path.join(current_file_dir, include_path))
            
            # 逻辑 2：尝试相对于脚本执行的根路径解析 (core/providers/...)
            path_relative_to_root = os.path.normpath(os.path.join(root_dir, include_path))
            
            if os.path.exists(path_relative_to_file):
                dependencies.append(path_relative_to_file)
            elif os.path.exists(path_relative_to_root):
                dependencies.append(path_relative_to_root)
                
    return dependencies

def main():
    # 获取脚本运行的根目录
    root_dir = os.getcwd()
    source_extensions = ('.cc', '.cpp')
    
    print(f"--- 正在搜索目录: {root_dir} ---")

    for dirpath, _, filenames in os.walk(root_dir):
        for filename in filenames:
            if filename.endswith(source_extensions):
                full_source_path = os.path.join(dirpath, filename)
                
                # 获取该源码文件的依赖
                deps = get_dependencies(full_source_path, root_dir)
                
                # 打印结果（只打印找到依赖的文件）
                if deps:
                    relative_source = os.path.relpath(full_source_path, root_dir)
                    print(f"\n[Source]: {relative_source}")
                    for dep in set(deps): # set去重
                        relative_dep = os.path.relpath(dep, root_dir)
                        print(f"  └── [Header]: {relative_dep}")

if __name__ == "__main__":
    main()
